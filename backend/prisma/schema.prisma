generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [uuidOssp(map: "uuid-ossp"), postgis]
}


// =====================================================
// ENUMS
// =====================================================

enum UserRole {
  user
  admin
  moderator
}

enum UserStatus {
  active
  suspended
  banned
  deactivated
}

enum Gender {
  man
  woman
  non_binary
  other
  prefer_not_to_say
}

enum VerificationType {
  email
  phone
  photo
  id
}

enum SpaceVisibility {
  public
  friends_only
  private
}

enum MediaType {
  photo
  video
  audio
}

enum ConnectionRequestStatus {
  pending
  accepted
  rejected
  expired
}

enum NotificationType {
  connection_request
  connection_accepted
  new_message
  space_favorite
  space_visit
  profile_view
}

enum Platform {
  ios
  android
  web
}

enum ReportReason {
  harassment
  fake_profile
  inappropriate_content
  spam
  underage
  other
}

enum ReportStatus {
  pending
  investigating
  resolved
  dismissed
}

enum ModerationActionType {
  warning
  temporary_ban
  permanent_ban
  content_removal
}

enum MessageType {
  text
  image
  video
  audio
}

enum KeyType {
  curve25519
  rsa
}

// =====================================================
// MODELS
// =====================================================

model User {
  id           String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email        String     @unique @db.VarChar(255)
  phone        String?    @unique @db.VarChar(20)
  passwordHash String     @map("password_hash") @db.VarChar(255)
  role         UserRole   @default(user)
  status       UserStatus @default(active)
  lastActive   DateTime   @default(now()) @map("last_active") @db.Timestamptz(6)
  createdAt    DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime   @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  profile                    UserProfile?
  verifications              UserVerification[]
  refreshTokens              RefreshToken[]
  space                      Space?
  spaceVisits                SpaceVisit[]
  spaceFavorites             SpaceFavorite[]
  sentConnectionRequests     ConnectionRequest[]     @relation("SentRequests")
  receivedConnectionRequests ConnectionRequest[]     @relation("ReceivedRequests")
  connections1               Connection[]            @relation("User1Connections")
  connections2               Connection[]            @relation("User2Connections")
  blockedUsers               BlockedUser[]           @relation("Blocker")
  blockedByUsers             BlockedUser[]           @relation("Blocked")
  encryptionKeys             EncryptionKey[]
  sentMessages               Message[]               @relation("SentMessages")
  receivedMessages           Message[]               @relation("ReceivedMessages")
  notifications              Notification[]          @relation("UserNotifications")
  relatedNotifications       Notification[]          @relation("RelatedUserNotifications")
  notificationPreferences    NotificationPreference?
  deviceTokens               DeviceToken[]
  reportsMade                Report[]                @relation("Reporter")
  reportsReceived            Report[]                @relation("ReportedUser")
  reportsResolved            Report[]                @relation("ReportResolver")
  moderationActions          ModerationAction[]      @relation("ModeratedUser")
  moderationActionsCreated   ModerationAction[]      @relation("Moderator")
  activityLogs               UserActivityLog[]

  @@map("users")
}

model UserProfile {
  id              String                                 @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId          String                                 @unique @map("user_id") @db.Uuid
  firstName       String                                 @map("first_name") @db.VarChar(50)
  age             Int
  gender          Gender?
  location        Unsupported("geography(Point, 4326)")?
  city            String?                                @db.VarChar(100)
  state           String?                                @db.VarChar(100)
  country         String?                                @db.VarChar(100)
  bio             String?                                @db.Text
  profilePhotoUrl String?                                @map("profile_photo_url") @db.Text
  heightCm        Int?                                   @map("height_cm")
  education       String?                                @db.VarChar(100)
  occupation      String?                                @db.VarChar(100)
  createdAt       DateTime                               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime                               @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model UserVerification {
  id                String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId            String           @map("user_id") @db.Uuid
  verificationType  VerificationType @map("verification_type")
  verified          Boolean          @default(false)
  verificationToken String?          @map("verification_token") @db.VarChar(255)
  verifiedAt        DateTime?        @map("verified_at") @db.Timestamptz(6)
  expiresAt         DateTime?        @map("expires_at") @db.Timestamptz(6)
  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_verifications")
}

model RefreshToken {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar(500)
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  revoked   Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Space {
  id                     String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId                 String          @unique @map("user_id") @db.Uuid
  bio                    String          @db.Text
  relationshipIntentions String[]        @map("relationship_intentions") @db.Text
  interests              String[]        @db.Text
  lookingFor             String?         @map("looking_for") @db.Text
  visibility             SpaceVisibility @default(public)
  isActive               Boolean         @default(true) @map("is_active")
  viewCount              Int             @default(0) @map("view_count")
  favoriteCount          Int             @default(0) @map("favorite_count")
  createdAt              DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  media     SpaceMedia[]
  visits    SpaceVisit[]
  favorites SpaceFavorite[]

  @@map("spaces")
}

model SpaceMedia {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  spaceId      String    @map("space_id") @db.Uuid
  mediaUrl     String    @map("media_url") @db.Text
  mediaType    MediaType @map("media_type")
  thumbnailUrl String?   @map("thumbnail_url") @db.Text
  displayOrder Int       @map("display_order")
  isPrimary    Boolean   @default(false) @map("is_primary")
  uploadedAt   DateTime  @default(now()) @map("uploaded_at") @db.Timestamptz(6)

  space Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@map("space_media")
}

model SpaceVisit {
  id              String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  spaceId         String   @map("space_id") @db.Uuid
  visitorId       String   @map("visitor_id") @db.Uuid
  durationSeconds Int?     @map("duration_seconds")
  visitedAt       DateTime @default(now()) @map("visited_at") @db.Timestamptz(6)

  space   Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  visitor User  @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  @@unique([spaceId, visitorId, visitedAt], name: "unique_visit")
  @@map("space_visits")
}

model SpaceFavorite {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  spaceId     String   @map("space_id") @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  favoritedAt DateTime @default(now()) @map("favorited_at") @db.Timestamptz(6)

  space Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([spaceId, userId], name: "unique_favorite")
  @@map("space_favorites")
}

model ConnectionRequest {
  id          String                  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  fromUserId  String                  @map("from_user_id") @db.Uuid
  toUserId    String                  @map("to_user_id") @db.Uuid
  message     String?                 @db.Text
  status      ConnectionRequestStatus @default(pending)
  createdAt   DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)
  expiresAt   DateTime                @default(dbgenerated("(CURRENT_TIMESTAMP + '7 days'::interval)")) @map("expires_at") @db.Timestamptz(6)
  respondedAt DateTime?               @map("responded_at") @db.Timestamptz(6)

  fromUser User @relation("SentRequests", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser   User @relation("ReceivedRequests", fields: [toUserId], references: [id], onDelete: Cascade)

  @@unique([fromUserId, toUserId], name: "unique_connection_request")
  @@map("connection_requests")
}

model Connection {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user1Id       String    @map("user1_id") @db.Uuid
  user2Id       String    @map("user2_id") @db.Uuid
  connectedAt   DateTime  @default(now()) @map("connected_at") @db.Timestamptz(6)
  lastMessageAt DateTime? @map("last_message_at") @db.Timestamptz(6)

  user1 User @relation("User1Connections", fields: [user1Id], references: [id], onDelete: Cascade)
  user2 User @relation("User2Connections", fields: [user2Id], references: [id], onDelete: Cascade)

  @@unique([user1Id, user2Id], name: "unique_connection")
  @@map("connections")
}

model BlockedUser {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  blockerId String   @map("blocker_id") @db.Uuid
  blockedId String   @map("blocked_id") @db.Uuid
  reason    String?  @db.Text
  blockedAt DateTime @default(now()) @map("blocked_at") @db.Timestamptz(6)

  blocker User @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId], name: "unique_block")
  @@map("blocked_users")
}

model EncryptionKey {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  publicKey String    @map("public_key") @db.Text
  keyType   KeyType   @default(curve25519) @map("key_type")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  expiresAt DateTime? @map("expires_at") @db.Timestamptz(6)
  isActive  Boolean   @default(true) @map("is_active")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("encryption_keys")
}

model Message {
  id               String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  fromUserId       String      @map("from_user_id") @db.Uuid
  toUserId         String      @map("to_user_id") @db.Uuid
  encryptedContent String      @map("encrypted_content") @db.Text
  messageType      MessageType @default(text) @map("message_type")
  sentAt           DateTime    @default(now()) @map("sent_at") @db.Timestamptz(6)
  deliveredAt      DateTime?   @map("delivered_at") @db.Timestamptz(6)
  readAt           DateTime?   @map("read_at") @db.Timestamptz(6)
  isDeleted        Boolean     @default(false) @map("is_deleted")
  deletedAt        DateTime?   @map("deleted_at") @db.Timestamptz(6)

  fromUser User           @relation("SentMessages", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser   User           @relation("ReceivedMessages", fields: [toUserId], references: [id], onDelete: Cascade)
  media    MessageMedia[]

  @@map("messages")
}

model MessageMedia {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  messageId    String    @map("message_id") @db.Uuid
  encryptedUrl String    @map("encrypted_url") @db.Text
  mediaType    MediaType @map("media_type")
  thumbnailUrl String?   @map("thumbnail_url") @db.Text
  fileSize     Int?      @map("file_size")
  uploadedAt   DateTime  @default(now()) @map("uploaded_at") @db.Timestamptz(6)

  message Message @relation(fields: [messageId], references: [id])

  @@map("message_media")
}

model Notification {
  id                String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId            String           @map("user_id") @db.Uuid
  type              NotificationType
  title             String           @db.VarChar(255)
  content           String?          @db.Text
  relatedUserId     String?          @map("related_user_id") @db.Uuid
  relatedEntityType String?          @map("related_entity_type") @db.VarChar(50)
  relatedEntityId   String?          @map("related_entity_id") @db.Uuid
  isRead            Boolean          @default(false) @map("is_read")
  readAt            DateTime?        @map("read_at") @db.Timestamptz(6)
  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)

  user        User  @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  relatedUser User? @relation("RelatedUserNotifications", fields: [relatedUserId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model NotificationPreference {
  id                      String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId                  String   @unique @map("user_id") @db.Uuid
  connectionRequestPush   Boolean  @default(true) @map("connection_request_push")
  connectionRequestEmail  Boolean  @default(true) @map("connection_request_email")
  connectionAcceptedPush  Boolean  @default(true) @map("connection_accepted_push")
  connectionAcceptedEmail Boolean  @default(false) @map("connection_accepted_email")
  newMessagePush          Boolean  @default(true) @map("new_message_push")
  newMessageEmail         Boolean  @default(false) @map("new_message_email")
  spaceFavoritePush       Boolean  @default(true) @map("space_favorite_push")
  spaceFavoriteEmail      Boolean  @default(false) @map("space_favorite_email")
  spaceVisitPush          Boolean  @default(false) @map("space_visit_push")
  spaceVisitEmail         Boolean  @default(false) @map("space_visit_email")
  createdAt               DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model DeviceToken {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  token      String   @unique @db.Text
  platform   Platform
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  lastUsedAt DateTime @default(now()) @map("last_used_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("device_tokens")
}

model Report {
  id              String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  reporterId      String       @map("reporter_id") @db.Uuid
  reportedUserId  String       @map("reported_user_id") @db.Uuid
  reason          ReportReason
  description     String?      @db.Text
  contentType     String?      @map("content_type") @db.VarChar(50)
  contentId       String?      @map("content_id") @db.Uuid
  status          ReportStatus @default(pending)
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  resolvedAt      DateTime?    @map("resolved_at") @db.Timestamptz(6)
  resolvedBy      String?      @map("resolved_by") @db.Uuid
  resolutionNotes String?      @map("resolution_notes") @db.Text

  reporter     User  @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedUser User  @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: Cascade)
  resolver     User? @relation("ReportResolver", fields: [resolvedBy], references: [id])

  @@map("reports")
}

model ModerationAction {
  id           String               @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId       String               @map("user_id") @db.Uuid
  actionType   ModerationActionType @map("action_type")
  reason       String               @db.Text
  durationDays Int?                 @map("duration_days")
  expiresAt    DateTime?            @map("expires_at") @db.Timestamptz(6)
  createdBy    String               @map("created_by") @db.Uuid
  createdAt    DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)

  user      User @relation("ModeratedUser", fields: [userId], references: [id], onDelete: Cascade)
  moderator User @relation("Moderator", fields: [createdBy], references: [id])

  @@map("moderation_actions")
}

model UserActivityLog {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  action    String   @db.VarChar(50)
  metadata  Json?    @db.JsonB
  ipAddress String?  @map("ip_address") @db.Inet
  userAgent String?  @map("user_agent") @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_activity_log")
}
